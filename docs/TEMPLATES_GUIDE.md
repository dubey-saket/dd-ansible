# DataDog Check Templates Guide

## Overview
Templates are Jinja2-based configuration files that generate DataDog check configurations dynamically. They allow for flexible, environment-specific, and host-specific DataDog monitoring configurations without hardcoding values.

## What Are Templates?

### Purpose
Templates serve as blueprints for generating DataDog agent check configurations. They:
- **Standardize** check configurations across environments
- **Customize** configurations based on host variables and detected applications
- **Maintain** consistency while allowing flexibility
- **Automate** the creation of complex DataDog check configurations

### How Templates Work

1. **Template Processing**: Ansible processes Jinja2 templates during playbook execution
2. **Variable Substitution**: Template variables are replaced with actual values
3. **Conditional Logic**: Templates can include conditional statements based on host facts
4. **File Generation**: Processed templates generate actual DataDog configuration files
5. **Agent Loading**: DataDog agent loads the generated configurations

### Template Structure
```yaml
# Template file: templates/http_check.yaml.j2
---
# HTTP Check Configuration
# Generated by Ansible - Do not edit manually

init_config:

instances:
{% for instance in datadog_checks_merged.http_check.instances %}
  - name: "{{ instance.name }}"
    url: "{{ instance.url }}"
    timeout: {{ instance.timeout | default(10) }}
    {% if instance.tags is defined %}
    tags:
{% for tag in instance.tags %}
      - "{{ tag }}"
{% endfor %}
    {% endif %}
{% endfor %}
```

## Available Templates

### 1. HTTP Check Template (`http_check.yaml.j2`)
**Purpose**: Monitor HTTP endpoints and services

**Generated Configuration**:
```yaml
# /etc/datadog-agent/conf.d/http_check.d/http_check.yaml
---
init_config:

instances:
  - name: "Health Check"
    url: "http://localhost:8080/health"
    timeout: 10
    tags:
      - "env:dev"
      - "service:web"
```

**Usage Example**:
```yaml
datadog_checks_dev:
  http_check:
    init_config:
    instances:
      - name: "Dev Health Check"
        url: "http://localhost:8080/health"
        timeout: 10
        tags:
          - "env:dev"
          - "service:web"
```

### 2. Disk Check Template (`disk_check.yaml.j2`)
**Purpose**: Monitor disk usage and performance

**Generated Configuration**:
```yaml
# /etc/datadog-agent/conf.d/disk.d/disk.yaml
---
init_config:

instances:
  - use_mount: true
    exclude:
      - /proc/*
      - /sys/*
      - /dev/*
    warning: 80
    critical: 90
    tags:
      - "env:prod"
```

### 3. System Check Template (`system_check.yaml.j2`)
**Purpose**: Monitor system metrics (CPU, memory, load)

**Generated Configuration**:
```yaml
# /etc/datadog-agent/conf.d/system.d/system.yaml
---
init_config:

instances:
  - collect_cpu_time: true
    report_active: true
    warning: 80
    critical: 95
    tags:
      - "env:prod"
```

### 4. Windows Service Template (`windows_service.yaml.j2`)
**Purpose**: Monitor Windows services

**Generated Configuration**:
```yaml
# C:\ProgramData\Datadog\conf.d\windows_service.d\windows_service.yaml
---
init_config:

instances:
  - services:
      - "DatadogAgent"
      - "W3SVC"
    tags:
      - "os:windows"
```

### 5. Nginx Check Template (`nginx_check.yaml.j2`)
**Purpose**: Monitor Nginx web servers

**Generated Configuration**:
```yaml
# /etc/datadog-agent/conf.d/nginx.d/nginx.yaml
---
init_config:

instances:
  - nginx_status_url: "http://localhost/nginx_status"
    collect_nginx_metrics: true
    tags:
      - "service:nginx"
      - "env:prod"
```

### 6. MySQL Check Template (`mysql_check.yaml.j2`)
**Purpose**: Monitor MySQL databases

**Generated Configuration**:
```yaml
# /etc/datadog-agent/conf.d/mysql.d/mysql.yaml
---
init_config:

instances:
  - host: "localhost"
    port: 3306
    user: "datadog"
    password: "{{ vault_mysql_password }}"
    tags:
      - "database:mysql"
      - "env:prod"
```

### 7. PostgreSQL Check Template (`postgres_check.yaml.j2`)
**Purpose**: Monitor PostgreSQL databases

**Generated Configuration**:
```yaml
# /etc/datadog-agent/conf.d/postgres.d/postgres.yaml
---
init_config:

instances:
  - host: "localhost"
    port: 5432
    user: "datadog"
    password: "{{ vault_postgres_password }}"
    dbname: "postgres"
    tags:
      - "database:postgres"
      - "env:prod"
```

### 8. Apache Check Template (`apache_check.yaml.j2`)
**Purpose**: Monitor Apache web servers

**Generated Configuration**:
```yaml
# /etc/datadog-agent/conf.d/apache.d/apache.yaml
---
init_config:

instances:
  - apache_status_url: "http://localhost/server-status"
    tags:
      - "service:apache"
      - "env:prod"
```

## When to Add New Templates

### Scenarios for New Templates

1. **New Application Integration**:
   - When deploying new applications that need monitoring
   - When existing templates don't cover specific use cases
   - When custom metrics are required

2. **Environment-Specific Requirements**:
   - Different monitoring requirements per environment
   - Custom alerting thresholds
   - Specialized service monitoring

3. **Compliance Requirements**:
   - Regulatory monitoring requirements
   - Security monitoring needs
   - Audit trail requirements

### Template Creation Process

#### Step 1: Identify the Need
```bash
# Check if existing templates cover your use case
ls -la templates/
cat templates/http_check.yaml.j2
```

#### Step 2: Create Template File
```bash
# Create new template in templates/ directory
vim templates/redis_check.yaml.j2
```

#### Step 3: Template Structure
```yaml
---
# Redis Check Configuration
# Generated by Ansible - Do not edit manually

init_config:

instances:
{% for instance in datadog_checks_merged.redis.instances %}
  - host: "{{ instance.host | default('localhost') }}"
    port: {{ instance.port | default(6379) }}
    {% if instance.password is defined %}
    password: "{{ instance.password }}"
    {% endif %}
    {% if instance.tags is defined %}
    tags:
{% for tag in instance.tags %}
      - "{{ tag }}"
{% endfor %}
    {% endif %}
{% endfor %}
```

#### Step 4: Add Template Processing
Add to `playbooks/tasks/configure_checks.yml`:
```yaml
- name: Configure redis check template
  template:
    src: "redis_check.yaml.j2"
    dest: "/etc/datadog-agent/conf.d/redis.d/redis.yaml"
    owner: dd-agent
    group: dd-agent
    mode: '0644'
  when: datadog_checks_merged.redis is defined
```

#### Step 5: Configure Check Data
Add to environment or application configuration:
```yaml
datadog_checks_dev:
  redis:
    init_config:
    instances:
      - host: "localhost"
        port: 6379
        tags:
          - "env:dev"
          - "service:redis"
```

## Template Best Practices

### 1. **Template Design**
- **Use Defaults**: Provide sensible defaults for all parameters
- **Conditional Logic**: Use Jinja2 conditionals for optional parameters
- **Error Handling**: Include validation for required parameters
- **Documentation**: Add comments explaining template purpose

### 2. **Variable Usage**
```yaml
# Good: Use defaults and conditionals
timeout: {{ instance.timeout | default(10) }}
{% if instance.password is defined %}
password: "{{ instance.password }}"
{% endif %}

# Bad: Direct variable usage without defaults
timeout: {{ instance.timeout }}
password: "{{ instance.password }}"
```

### 3. **Security Considerations**
```yaml
# Use vault variables for sensitive data
password: "{{ vault_database_password }}"

# Don't hardcode credentials
password: "hardcoded_password"  # BAD
```

### 4. **Template Organization**
```
templates/
├── system_checks/
│   ├── cpu_check.yaml.j2
│   ├── memory_check.yaml.j2
│   └── disk_check.yaml.j2
├── web_servers/
│   ├── nginx_check.yaml.j2
│   ├── apache_check.yaml.j2
│   └── iis_check.yaml.j2
└── databases/
    ├── mysql_check.yaml.j2
    ├── postgres_check.yaml.j2
    └── redis_check.yaml.j2
```

## Advanced Template Features

### 1. **Loop Processing**
```yaml
# Process multiple instances
instances:
{% for instance in datadog_checks_merged.http_check.instances %}
  - name: "{{ instance.name }}"
    url: "{{ instance.url }}"
    {% if instance.tags is defined %}
    tags:
{% for tag in instance.tags %}
      - "{{ tag }}"
{% endfor %}
    {% endif %}
{% endfor %}
```

### 2. **Conditional Configuration**
```yaml
# Environment-specific configuration
{% if target_environment == "prod" %}
warning: 70
critical: 85
{% else %}
warning: 80
critical: 90
{% endif %}
```

### 3. **Host-Specific Variables**
```yaml
# Use host facts
hostname: "{{ ansible_hostname }}"
os_family: "{{ ansible_os_family }}"
distribution: "{{ ansible_distribution }}"
```

### 4. **Custom Filters**
```yaml
# Use Jinja2 filters
timestamp: "{{ ansible_date_time.iso8601 }}"
uppercase_env: "{{ target_environment | upper }}"
lowercase_service: "{{ service_name | lower }}"
```

## Template Testing

### 1. **Syntax Validation**
```bash
# Check Jinja2 syntax
python3 -c "from jinja2 import Template; Template(open('templates/redis_check.yaml.j2').read())"
```

### 2. **Test Data Validation**
```bash
# Test with sample data
ansible-playbook --check --diff playbooks/datadog_agent.yml \
  -i inventories/test/hosts.yml \
  -e target_environment=test \
  --tags custom_checks
```

### 3. **Generated Configuration Review**
```bash
# Review generated configurations
find /etc/datadog-agent/conf.d/ -name "*.yaml" -exec cat {} \;
```

## Troubleshooting Templates

### Common Issues

1. **Template Syntax Errors**:
   ```yaml
   # Check Jinja2 syntax
   {% if condition %}
   # content
   {% endif %}  # Must match opening tag
   ```

2. **Variable Not Defined**:
   ```yaml
   # Use default values
   timeout: {{ instance.timeout | default(10) }}
   ```

3. **File Permissions**:
   ```yaml
   # Ensure correct permissions
   mode: '0644'
   owner: dd-agent
   group: dd-agent
   ```

4. **Configuration Validation**:
   ```bash
   # Validate generated configuration
   datadog-agent configcheck
   ```

### Debug Template Processing
```bash
# Run with verbose output
ansible-playbook -vvv playbooks/datadog_agent.yml \
  -i inventories/dev/hosts.yml \
  --tags custom_checks

# Check template processing
ansible-playbook --check playbooks/datadog_agent.yml \
  -i inventories/dev/hosts.yml \
  --tags custom_checks
```

## Template Maintenance

### 1. **Version Control**
- Keep templates in version control
- Use descriptive commit messages
- Tag template versions for releases

### 2. **Documentation Updates**
- Update this guide when adding new templates
- Document template parameters and usage
- Provide examples for new templates

### 3. **Testing**
- Test templates with different environments
- Validate generated configurations
- Ensure backward compatibility

### 4. **Monitoring**
- Monitor DataDog agent logs for template-related errors
- Set up alerts for configuration validation failures
- Track template usage across environments

This comprehensive template system provides flexibility, maintainability, and consistency for DataDog monitoring configurations across all environments and operating systems.
