# DataDog Agent Configuration
# Generated by Ansible

# API Key
api_key: {{ datadog_api_key }}

# Site configuration
site: {{ datadog_site | default('datadoghq.com') }}

# Logging configuration
log_level: {{ datadog_config.log_level | default('INFO') }}

# Tags
tags:
{% for tag in datadog_global_tags | default([]) %}
  - {{ tag }}
{% endfor %}
{% for tag in datadog_env_tags | default([]) %}
  - {{ tag }}
{% endfor %}
{% for tag in datadog_app_tags | default([]) %}
  - {{ tag }}
{% endfor %}
{% for tag in datadog_role_tags | default([]) %}
  - {{ tag }}
{% endfor %}
{% for tag in datadog_host_tags | default([]) %}
  - {{ tag }}
{% endfor %}

# APM configuration
apm_config:
  enabled: {{ datadog_config.apm_config.enabled | default(true) | lower }}

# Logs configuration
logs_enabled: {{ datadog_config.logs_enabled | default(true) | lower }}

# Process configuration
process_config:
  enabled: {{ datadog_agent_config.process_config.enabled | default(true) | lower }}

# Network configuration
network_config:
  enabled: {{ datadog_agent_config.network_config.enabled | default(true) | lower }}

# Hostname
hostname: {{ inventory_hostname }}

# Check configuration
{% if group_datadog_checks is defined or host_datadog_checks is defined %}
datadog_checks:
{% if group_datadog_checks is defined %}
{% for check_name, check_config in group_datadog_checks.items() %}
  {{ check_name }}:
    init_config:
{% if check_config.init_config is defined %}
{% for key, value in check_config.init_config.items() %}
      {{ key }}: {{ value | to_nice_json }}
{% endfor %}
{% endif %}
    instances:
{% for instance in check_config.instances | default([]) %}
      - {{ instance | to_nice_json }}
{% endfor %}
{% endfor %}
{% endif %}
{% if host_datadog_checks is defined %}
{% for check_name, check_config in host_datadog_checks.items() %}
  {{ check_name }}:
    init_config:
{% if check_config.init_config is defined %}
{% for key, value in check_config.init_config.items() %}
      {{ key }}: {{ value | to_nice_json }}
{% endfor %}
{% endif %}
    instances:
{% for instance in check_config.instances | default([]) %}
      - {{ instance | to_nice_json }}
{% endfor %}
{% endfor %}
{% endif %}
{% endif %}

# Custom configuration
{% if datadog_agent_config is defined %}
{% for key, value in datadog_agent_config.items() %}
{% if key not in ['process_config', 'network_config'] %}
{{ key }}: {{ value | to_nice_json }}
{% endif %}
{% endfor %}
{% endif %}
